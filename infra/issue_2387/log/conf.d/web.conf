### Input Plugin

### Output Plugin
<match ec.web.cake.*>
  @type copy
  <store>
    @type file
    path /var/log/web/${tag}
    symlink_path /var/log/web/current-${tag}
    compress gzip
    append true
    <buffer tag,time>
      @type file
      path /var/log/web/buffer/out_file/ec.web.cake.*
      chunk_limit_size 10k ######## Test config
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
<store>
    @type s3
    aws_key_id アクセスキー
    aws_sec_key シークレットキー
    path logs/application/thebase.in/${tag}/%Y/%m/%d/
    s3_bucket tomy-sre-accesslog
    s3_object_key_format %{path}${tag}.%{time_slice}_%{index}.%{file_extension}
    s3_region ap-northeast-1
    time_slice_format %Y%m%d_%H
    <buffer tag,time>
      @type file
      # retry_max_times指定はS3へのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
      #chunk_limit_size 64m
      chunk_limit_size 10k
      path /var/log/web/buffer/out_s3/ec.web.cake.*
      timekey 1h # chunk_limit_sizeを超えない場合の間隔
      #timekey_wait 5m
      timekey_wait 0
      retry_wait 30s
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  <store>
    @type elasticsearch
    hosts https://vpc-tomy-sre-elasticsearch-f4z5xgxiymv7aftrqofe4wdj7u.ap-northeast-1.es.amazonaws.com:443
    logstash_format true
    #logstash_prefix ${tag[1]}-${tag[2]}-${tag[3]}
    logstash_prefix ${tag}
    reload_connections false # https://github.com/uken/fluent-plugin-elasticsearch#reload_connections
    utc_index false
    <buffer tag,time>
      @type file
      path /var/log/web/buffer/out_elasticsearch/ec.web.cake.*
      timekey 30s # chunk_limit_sizeを超えない場合の間隔
      timekey_wait 0
      #chunk_limit_size 9m
      chunk_limit_size 10k
      retry_wait 30s
      flush_thread_count 4
      # retry_max_times指定はESへのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
    </buffer>
  </store>
</match>

<match ec.web.apache_access.*>
  @type copy
  <store>
    @type file
    path /var/log/web/${tag}
    symlink_path /var/log/web/current-${tag}
    compress gzip
    append true
    <buffer tag,time>
      @type file
      path /var/log/web/buffer/out_file/ec.web.apache_access.*
      chunk_limit_size 10k ######## Test config
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  <store>
    @type elasticsearch
    hosts https://vpc-tomy-sre-elasticsearch-f4z5xgxiymv7aftrqofe4wdj7u.ap-northeast-1.es.amazonaws.com:443
    logstash_format true
    #logstash_prefix ${tag[1]}-${tag[2]}-${tag[3]}
    logstash_prefix ${tag}
    reload_connections false # https://github.com/uken/fluent-plugin-elasticsearch#reload_connections
    utc_index false
    <buffer tag,time>
      @type file
      #chunk_limit_size 9m
      chunk_limit_size 10k
      flush_thread_count 4
      path /var/log/web/buffer/out_elasticsearch/ec.web.apache_access.*
      retry_wait 30s
      timekey 30s # chunk_limit_sizeを超えない場合の間隔
      timekey_wait 0
      # retry_max_times指定はESへのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
    </buffer>
  </store>
  <store>
    @type s3
    aws_key_id アクセスキー
    aws_sec_key シークレットキー
    path logs/apache/${tag[3]}/year=%Y/month=%m/day=%d/
    s3_bucket tomy-sre-accesslog
    s3_object_key_format %{path}${tag}.%{time_slice}_%{index}.%{file_extension}
    s3_region ap-northeast-1
    time_slice_format %Y%m%d_%H
    <buffer tag,time>
      @type file
      #chunk_limit_size 64m
      chunk_limit_size 10k
      path /var/log/web/buffer/out_s3/ec.web.apache_access.*
      retry_wait 30s
      # retry_max_times指定はS3へのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
      timekey 1h # chunk_limit_sizeを超えない場合の間隔
      #timekey_wait 5m
      timekey_wait 0
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  <store>
    @type forward
    <server>
      host 10.103.4.218
      port 24224
    </server>
    require_ack_response true
    ack_response_timeout 190
    send_timeout 60
    recover_wait 10
    heartbeat_type transport
    heartbeat_interval 1
    phi_failure_detector true
    phi_threshold 16
    hard_timeout 60

    ### Buffer Plugin
    <buffer>
      @type file
      path /var/log/web/buffer/out_forward/ec.web.apache_access.*
      flush_mode interval
      flush_interval 10
    </buffer>
  </store>
</match>

<match ec.web.apache_error.*>
  @type copy
  <store>
    @type file
    path /var/log/web/${tag}
    symlink_path /var/log/web/current-${tag}
    compress gzip
    append true
    <buffer tag,time>
      @type file
      path /var/log/web/buffer/out_file/ec.web.apache_error.*
      chunk_limit_size 10k ######## Test config
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  <store>
    @type elasticsearch
    hosts https://vpc-tomy-sre-elasticsearch-f4z5xgxiymv7aftrqofe4wdj7u.ap-northeast-1.es.amazonaws.com:443
    logstash_format true
    #logstash_prefix ${tag[1]}-${tag[2]}-${tag[3]}
    logstash_prefix ${tag}
    reload_connections false # https://github.com/uken/fluent-plugin-elasticsearch#reload_connections
    utc_index false
    time_key_format %Y-%m-%dT%H:%M:%S.%N%z
    <buffer tag,time>
      @type file
      path /var/log/web/buffer/out_elasticsearch/ec.web.apache_error.*
      timekey 30s # chunk_limit_sizeを超えない場合の間隔
      timekey_wait 0
      #chunk_limit_size 9m
      chunk_limit_size 10k
      retry_wait 30s
      flush_thread_count 4
      # retry_max_times指定はESへのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
    </buffer>
  </store>
  <store>
  <store>
    @type s3
    aws_key_id アクセスキー
    aws_sec_key シークレットキー
    path logs/apache_error/${tag[3]}/year=%Y/month=%m/day=%d/
    s3_bucket tomy-sre-accesslog
    s3_region ap-northeast-1
    s3_object_key_format %{path}${tag}.%{time_slice}_%{index}.%{file_extension}
    time_slice_format %Y%m%d_%H
    <buffer tag,time>
      @type file
      #chunk_limit_size 64m
      chunk_limit_size 10k
      path /var/log/web/buffer/out_s3/ec.web.apache_error.*
      retry_wait 30s
      # retry_max_times指定はS3へのログが欠損する恐れがあるので[Default: none]としてみる
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
      timekey 1h # chunk_limit_sizeを超えない場合の間隔
      #timekey_wait 5m
      timekey_wait 0
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
</match>
