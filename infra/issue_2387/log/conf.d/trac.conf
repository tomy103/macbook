### Input Plugin

### Output Plugin
<match ec.trac.nginx_access.*>
  @type copy
  <store>
    @type file
    append true
    compress gzip
    path /var/log/trac/${tag}
    symlink_path /var/log/trac/current-${tag}
    <buffer tag,time>
      @type file
      chunk_limit_size 10k ######## Test config
      path /var/log/trac/buffer/out_file/ec.trac.nginx_access.*
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  <store>
    @type s3
    aws_key_id アクセスキー
    aws_sec_key シークレットキー
    path logs/application/trac.thebase.in/%Y/%m/%d/
    s3_bucket tomy-sre-acceesslog
    s3_region ap-northeast-1
    s3_object_key_format %{path}${tag}.%{time_slice}_%{index}.%{file_extension}
    time_slice_format %Y%m%d_%H
    <buffer tag,time>
      @type file
      #chunk_limit_size 64m
      chunk_limit_size 10k
      # flush_at_shutdownは今回file bufferにしたので[Default: false]としてみる
      path /var/log/trac/buffer/out_s3/ec.trac.nginx_access.*
      retry_wait 30s
      # retry_max_times指定はS3へのログが欠損する恐れがあるので[Default: none]としてみる
      timekey 1h # chunk_limit_sizeを超えない場合の間隔
      #timekey_wait 5m
      timekey_wait 0
    </buffer>
    <format>
      @type json
    </format>
    <inject>
      time_key time
      time_type string
      tag_key tag
    </inject>
  </store>
  ### BigQueryは ${tag[3]}単位で分岐しないといけないかも...！
  <store>
    @type bigquery_insert
    auto_create_table true
    auth_method json_key
    dataset tomy_sre_web_action
    json_key /etc/td-agent/conf.d/bigquery/json_key/staging.json
    project bigquerydevelopment
    schema_path /etc/td-agent/conf.d/bigquery/schema/trac.json
    table action_logs_%Y%m%d
    <buffer time>
      @type file
      flush_mode interval
###      flush_interval 60
      flush_interval 1
      path /var/log/trac/buffer/out_bigquery/ec.trac.nginx_access.*
      timekey 1d
    </buffer>
  </store>

### to DS
#  <store>
#    @type forward
#    <server>
#      host vpce-012cbe2aafb2e4b98-n6f7xxn7-ap-northeast-1c.vpce-svc-0d9657e0946db800d.ap-northeast-1.vpce.amazonaws.com
#      port 24224
#    </server>
#    ack_response_timeout 190
#    hard_timeout 60
#    heartbeat_type transport
#    heartbeat_interval 1
#    phi_failure_detector true
#    phi_threshold 16
#    recover_wait 10
#    require_ack_response true
#    send_timeout 60
#
#    ### Buffer Plugin
#    <buffer>
#      @type file
#      flush_mode interval
#      flush_interval 10
#      path /var/log/td-agent/buffer/out_forward/ec.trac.nginx_access.*
#    </buffer>
#  </store>

</match>
